#!/bin/bash

# Install dependencies
if command -v apt-get > /dev/null; then
  apt-get update
  # On Debian Buster and Ubuntu Focal, install newer motion from GitHub
  FILE=''
  MOTION='motion'
  DISTRO=''
  [[ -f '/etc/os-release' ]] && DISTRO=$(sed -n '/^VERSION_CODENAME=/{s/^[^=]*=//p;q}' /etc/os-release)
  if [[ $DISTRO == 'buster' || $DISTRO == 'focal' ]]; then
    MOTION_REL='4.3.2'
    MOTION_SUBREL='-1'
    ARCH=$(dpkg --print-architecture)
    # On ARMv6 Raspberry Pi models, download armv6hf package
    PI=''
    [[ $(uname -m) == 'armv6l' && -f '/sys/firmware/devicetree/base/model' ]] && grep -q 'aspberry' /sys/firmware/devicetree/base/model && PI='pi_'
    FILE="${PI}${DISTRO}_motion_${MOTION_REL}${MOTION_SUBREL}_${ARCH}.deb"
    command -v curl > /dev/null || apt-get -y install curl
    curl -fLO "https://github.com/Motion-Project/motion/releases/download/release-${MOTION_REL}/${FILE}"
    MOTION="./${FILE}"
  fi
  apt-get -y install "${MOTION}" curl v4l-utils ffmpeg curl python3-boto3
  [[ ${FILE} ]] && rm "${FILE}"
elif command -v yum > /dev/null; then
  yum -y install motion v4l-utils ffmpeg curl python3-boto3
else
  echo 'This system uses neither apt nor yum. Please install these dependencies manually:
  motion v4l-utils ffmpeg curl python3-boto3'
fi

# Pre-create config and data dirs and install configuration files
[[ -d '/etc/motioneye' ]] || mkdir /etc/motioneye
[[ -f '/etc/motioneye/motioneye.conf' ]] || cp extra/motioneye.conf.sample /etc/motioneye/motioneye.conf
chown -R motion.motion /etc/motioneye

# Install service
[[ -f '/etc/systemd/system/motioneye.service' ]] || cp extra/motioneye.systemd /etc/systemd/system/motioneye.service
systemctl daemon-reload
systemctl enable --now motioneye
